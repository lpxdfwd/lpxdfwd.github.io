---
title: 网络协议学习记录_tcp特性、性能、优化
tags: ['tcp']
---

现在网页上的请求基本都是http请求，而http请求就是基于tcp协议进行数据传输的。早期网页加载的速度受限于http协议，但随着http协议的发展，从最早的0.9版本到现在的2.0，从1.1的持久链接、域名分片到2.0的多路复用、首部压缩、基于二进制传输等优化，http已不再是网页加载的瓶颈，而tpc的一系列问题则暴漏了出来。

### tpc慢启动算法、拥塞窗口
tcp是一个可靠的数据传输协议，它保证了数据在传输过程中的完整性、有序性，在之前的文章中我们讲了，tpc需要通过三次握手进行连接，确保所链接服务器的准确性，在数据传输的过程中，tpc会给每个数据包标记一个序列号，当数据到达时，如果顺序不对，则会对数据包进行重排，以此来保证数据的有序性，如果传输过程中发生了丢包，则会对丢失的数据包进行重发，其余的数据包需要等重发的数据包完整到达后，才会被有序的处理，以此来保证数据的完整性。
tpc使用了慢启动算法，通过慢启动来感知当前网络最佳的数据流量，避免数据量过大堵塞或冲垮网络，tpc基于CWND（拥塞窗口）传输数据，能发送的最大的数据量取决于当前拥塞窗口的大小，起初拥塞窗口很小，当网络可以处理当前大小的数据量时，拥塞窗口的大小就会翻倍，如果还能处理翻倍后大小的数据量，则继续翻倍以指数的方式增长，当达到拥塞窗口的最大值后，进入拥塞避免阶段，窗口会以线性的方式缓慢持续增长。
慢启动和拥塞窗口虽然有效的避免了网络崩溃。但是也带来了很严重的性能问题，在tcp链接初期慢启动算法会导致延迟，性能浪费。在连接闲置时，tcp会认为网络环境发生变化，重新启动慢启动算法计算窗口大小。tcp协议对丢包的容忍性很差，当发生丢包时，拥塞窗口大小会直接减半，再次计算窗口大小，丢包还会早层tcp的数据堵塞，在数据传输过程中，同一批传输的数据如果有一个数据包丢失，客户端不会发送数据包的确认消息，服务器就会重新发送这个数据包，虽然其他数据包已经传输完成，但是为了保证数据的有序性，在丢包的数据发送完成钱，不能被使用。这个问题在http2中尤为严重，因为http2的多路复用使用的是单个链接，一次丢包会导致所有的资源下载速度变慢，而在http1.1中一个域名最多可以建立6个链接，一个链接上的数据发生丢包，并不会影响其余五个链接的数据下载，http2虽然解决了http层面上的队头阻塞，却无法解决tcp的队头堵塞。

### tpc性能优化
* 升级系统版本，tcp是由底层操作系统控制的，在操作系统以外很难对它进行更改，目前新版本的系统都会对tcp进行一些列的优化；
* 提高初始拥塞窗口大小，提高拥塞窗口的最大值（此设置一般被写死在操作系统内核中，除非升级操作系统，一般不建议修改），在linux的系统中都可以设置（$ cat /proc/sys/net/ipv4/tcp_window_scaling）；
* 使用SACK（选择性响应，响应乱序数据包），如果发生丢包，仅重传丢失的数据，其余的完整数据可以先被响应($ cat /proc/sys/net/ipv4/tcp_sack)；
* 禁止闲置一段时间后重启慢启动（$ sysctl -w net.ipv4.tcp_slow_start_after_idle=0）;
* 使用TFO允许tcp三次握手的初始SYN部分发送初始数据包，在三次握手的同时可以进行https的握手，节省初始链接时的时间开销(echo "3" > /proc/sys/net/ipv4/tcp_fastopen);
* 使用更加高效的拥塞控制算法，PRR、BBR，可以大幅度提高拥塞控制性能。